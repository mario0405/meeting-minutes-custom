name: Build and publish Tauri releases

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch: {}



permissions:
  contents: write

concurrency:
  group: release-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  build:
    defaults:
      run:
        working-directory: frontend
        shell: bash
    name: Build bundles for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm (install and cache)
        uses: pnpm/action-setup@v4
        with:
          package_json_file: frontend/package.json
          cache: true
          cache_dependency_path: frontend/pnpm-lock.yaml
          run_install: false

      - name: Sanity check pnpm/node
        run: |
          node -v
          pnpm -v
          pwd
          ls -la

      - name: Debug paths
        run: |
          echo "Current directory:"
          pwd

          echo "Files in current directory (frontend):"
          ls -la . || true

          echo "Repo root contents:"
          ls -la .. || true

          echo "Package.json (first 20 lines):"
          head -n 20 package.json || true

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux build deps
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libasound2-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libssl-dev \
            libsqlite3-dev \
            patchelf \
            pkg-config \
            rpm

      - name: Install macOS build deps
        if: matrix.os == 'macos-latest'
        run: |
          brew update || true
          brew install pkg-config openssl || true

      - name: Install Windows build deps
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          choco install openssl.light -y || true

      - name: Build Next.js frontend
        working-directory: frontend
        run: pnpm build

      - name: Build desktop bundles (Tauri)
        env:
          NO_STRIP: ${{ matrix.os == 'ubuntu-latest' && 'true' || '' }}
        run: pnpm tauri:build:cpu

      - name: Debug Tauri output locations
        shell: bash
        run: |
          echo "PWD=$(pwd)"
          echo "Listing src-tauri (if present):"; ls -la src-tauri || true
          echo "Listing repo root (parent):"; ls -la .. || true
          echo "Searching for 'bundle' directories anywhere (maxdepth 8):"
          find . -type d -name bundle -maxdepth 8 -print || true
          echo "Searching for common installer files (.dmg .msi .exe .deb .AppImage .rpm .zip):"
          find . -type f \( -iname '*.dmg' -o -iname '*.msi' -o -iname '*.exe' -o -iname '*.deb' -o -iname '*.AppImage' -o -iname '*.rpm' -o -iname '*.zip' \) -print || true


      - name: Package bundles (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          mkdir -p dist
          SOURCE_DIR="src-tauri/target/release/bundle"
          echo "Listing bundle files:" && ls -R "$SOURCE_DIR" || true
          tar -czf dist/linux.tar.gz -C "$SOURCE_DIR" .

      - name: Package bundles (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          mkdir -p dist
          SOURCE_DIR="src-tauri/target/release/bundle"
          echo "Listing bundle files:" && ls -R "$SOURCE_DIR" || true
          ditto -c -k --sequesterRsrc --keepParent "$SOURCE_DIR" "dist/macos.zip"

      - name: Package bundles (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          $SOURCE = "src-tauri\target\release\bundle\*"
          Write-Host "Listing bundle files:"; Get-ChildItem -Recurse -Force src-tauri\target\release\bundle || $true
          Compress-Archive -Path $SOURCE -DestinationPath dist/windows.zip -Force

      - name: Debug for Tauri bundles (search common bundle paths)
        shell: bash
        run: |
          echo "PWD=$(pwd)"
          echo "Listing tree (shallow):"; ls -la || true
          echo "Searching for 'bundle' dirs under src-tauri/ and target/":
          find src-tauri -type d -name bundle -maxdepth 8 -print || true
          find target -type d -name bundle -maxdepth 8 -print || true
          find src-tauri -type f -name '*.app' -maxdepth 8 -print || true
          echo "Show up to 200 files (no broken pipes):"
          find . -maxdepth 6 -type f -print | sed -n '1,200p' || true

      - name: Collect bundle/installers (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          mkdir -p release-assets
          echo "Searching common bundle/installer paths and copying into release-assets/..."
          find src-tauri target -type f \( -iname '*.dmg' -o -iname '*.msi' -o -iname '*.exe' -o -iname '*.deb' -o -iname '*.AppImage' -o -iname '*.rpm' -o -iname '*.zip' \) -print0 \
            | xargs -0 -I{} bash -c 'mkdir -p release-assets/$(dirname "{}" | sed "s#\./##; s#/#-#g") ; cp -v "{}" release-assets/ || true'
          echo "Collected files:" ; ls -R release-assets || true

      - name: Collect bundle/installers (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path release-assets | Out-Null
          $patterns = '*.exe','*.zip','*.msi','*.AppImage','*.dmg','*.deb','*.rpm'
          foreach ($p in $patterns) {
            Get-ChildItem -Path src-tauri,target -Recurse -Filter $p -ErrorAction SilentlyContinue | ForEach-Object {
              Copy-Item -Path $_.FullName -Destination (Join-Path $PWD 'release-assets') -Force
            }
          }
          Write-Host "Collected files:"; Get-ChildItem -Path release-assets -Recurse | Select-Object -First 200

      - name: Upload packaged bundle
        uses: actions/upload-artifact@v4
        with:
          name: assets-${{ matrix.os }}
          path: release-assets/**
          if-no-files-found: error

  publish:
    defaults:
      run:
        working-directory: .
        shell: bash
    name: Assemble and publish release assets
    needs: build
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: assets
          path: release-assets

      - name: List collected artifacts
        run: ls -R release-assets || true

      - name: Debug release-assets
        shell: bash
        run: |
          echo "PWD: $(pwd)"
          ls -la || true
          echo "Finding files under release-assets:"
          find release-assets -type f -maxdepth 6 -print || true

      - name: Create or update GitHub Release and upload assets
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release-assets/**/*.zip
            release-assets/**/*.tar.gz
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
