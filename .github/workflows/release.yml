name: Build and publish Tauri releases

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch: {}



permissions:
  contents: write

concurrency:
  group: release-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  build:
    defaults:
      run:
        working-directory: frontend
        shell: bash
    name: Build bundles for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm (install and cache)
        uses: pnpm/action-setup@v4
        with:
          package_json_file: frontend/package.json
          cache: true
          cache_dependency_path: frontend/pnpm-lock.yaml
          run_install: false

      - name: Sanity check pnpm/node
        run: |
          node -v
          pnpm -v
          pwd
          ls -la

      - name: Debug paths
        run: |
          echo "Current directory:"
          pwd

          echo "Files in current directory (frontend):"
          ls -la . || true

          echo "Repo root contents:"
          ls -la .. || true

          echo "Package.json (first 20 lines):"
          head -n 20 package.json || true

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux build deps
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libasound2-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libssl-dev \
            libsqlite3-dev \
            patchelf \
            pkg-config \
            rpm

      - name: Install macOS build deps
        if: matrix.os == 'macos-latest'
        run: |
          brew update || true
          brew install pkg-config openssl || true

      - name: Install Windows build deps
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          choco install openssl.light -y || true

      - name: Build Next.js frontend
        working-directory: frontend
        run: pnpm build

      - name: Build desktop bundles (Tauri)
        env:
          NO_STRIP: ${{ matrix.os == 'ubuntu-latest' && 'true' || '' }}
        run: pnpm tauri:build:cpu

      - name: Debug Tauri output locations
        shell: bash
        run: |
          echo "PWD=$(pwd)"
          echo "Listing src-tauri (if present):"; ls -la src-tauri || true
          echo "Listing repo root (parent):"; ls -la .. || true
          echo "Searching for 'bundle' directories anywhere (maxdepth 8):"
          find . -maxdepth 8 -type d -name bundle -print || true
          echo "Searching for common installer files (.dmg .msi .exe .deb .AppImage .rpm .zip):"
          find . -type f \( -iname '*.dmg' -o -iname '*.msi' -o -iname '*.exe' -o -iname '*.deb' -o -iname '*.AppImage' -o -iname '*.rpm' -o -iname '*.zip' \) -print || true

      - name: Collect release assets (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          OUT_DIR="../release-assets/${{ matrix.os }}"
          BUNDLE_DIR="src-tauri/target/release/bundle"

          mkdir -p "$OUT_DIR"

          if [ ! -d "$BUNDLE_DIR" ]; then
            echo "::error::Expected bundle dir not found: $BUNDLE_DIR"
            echo "Debug: showing src-tauri tree (depth 4):"
            find src-tauri -maxdepth 4 -type d -print || true
            exit 1
          fi

          ARCHIVE_BASENAME="bundle-${{ github.ref_name }}-${{ matrix.os }}"
          if [ "${{ runner.os }}" = "Linux" ]; then
            echo "Creating archive: $OUT_DIR/${ARCHIVE_BASENAME}.tar.gz"
            tar -czf "$OUT_DIR/${ARCHIVE_BASENAME}.tar.gz" -C "$BUNDLE_DIR" .
          else
            echo "Creating archive: $OUT_DIR/${ARCHIVE_BASENAME}.zip"
            ditto -c -k --sequesterRsrc --keepParent "$BUNDLE_DIR" "$OUT_DIR/${ARCHIVE_BASENAME}.zip"
          fi

          echo "Copying installer files into $OUT_DIR..."
          find "$BUNDLE_DIR" -maxdepth 8 -type f \
            \( -iname '*.dmg' -o -iname '*.AppImage' -o -iname '*.deb' -o -iname '*.rpm' -o -iname '*.msi' -o -iname '*.exe' \) \
            -print -exec cp -v {} "$OUT_DIR/" \; || true

          echo "Collected files:"
          ls -la "$OUT_DIR" || true

      - name: Collect release assets (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $OutDir = Join-Path $env:GITHUB_WORKSPACE ("release-assets\\${{ matrix.os }}")
          $BundleDir = Join-Path $env:GITHUB_WORKSPACE "frontend\\src-tauri\\target\\release\\bundle"

          New-Item -ItemType Directory -Force -Path $OutDir | Out-Null

          if (-Not (Test-Path $BundleDir)) {
            Write-Error "Expected bundle dir not found: $BundleDir"
            Get-ChildItem -Path (Join-Path $env:GITHUB_WORKSPACE "frontend\\src-tauri") -Directory -Recurse -Depth 4 -ErrorAction SilentlyContinue | Select-Object -First 200
            exit 1
          }

          $ArchiveName = "bundle-${{ github.ref_name }}-${{ matrix.os }}.zip"
          $ArchivePath = Join-Path $OutDir $ArchiveName
          if (Test-Path $ArchivePath) { Remove-Item $ArchivePath -Force }
          Write-Host "Creating archive: $ArchivePath"
          Compress-Archive -Path (Join-Path $BundleDir '*') -DestinationPath $ArchivePath -Force

          $patterns = '*.exe','*.msi'
          foreach ($p in $patterns) {
            Write-Host "Copying installers matching $p"
            Get-ChildItem -Path $BundleDir -Recurse -File -Filter $p -ErrorAction SilentlyContinue | ForEach-Object {
              Copy-Item -Path $_.FullName -Destination $OutDir -Force
            }
          }

          Write-Host "Collected files:"
          Get-ChildItem -Path $OutDir -Recurse | Select-Object -First 200

      - name: Upload release assets
        uses: actions/upload-artifact@v4
        with:
          name: assets-${{ matrix.os }}
          path: release-assets
          if-no-files-found: error

  publish:
    defaults:
      run:
        working-directory: .
        shell: bash
    name: Assemble and publish release assets
    needs: build
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: assets-*
          path: release-assets
          merge-multiple: true

      - name: List collected artifacts
        run: ls -R release-assets || true

      - name: Debug release-assets
        shell: bash
        run: |
          echo "PWD: $(pwd)"
          ls -la || true
          echo "Finding files under release-assets:"
          find release-assets -type f -maxdepth 6 -print || true

      - name: Ensure release assets exist
        shell: bash
        run: |
          set -euo pipefail
          file_count="$(find release-assets -type f | wc -l | tr -d ' ')"
          echo "Release asset file count: $file_count"
          if [ "$file_count" -eq 0 ]; then
            echo "::error::No release assets found after downloading build artifacts."
            exit 1
          fi

      - name: Create or update GitHub Release and upload assets
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v2
        with:
          name: "Protocolito ${{ github.ref_name }}"
          body_path: .github/RELEASE_TEMPLATE.md
          files: |
            release-assets/**/*.zip
            release-assets/**/*.tar.gz
            release-assets/**/*.dmg
            release-assets/**/*.msi
            release-assets/**/*.exe
            release-assets/**/*.deb
            release-assets/**/*.AppImage
            release-assets/**/*.rpm
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
